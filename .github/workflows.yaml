name: Deploy
run-name: Deploy to ${{ github.repository }} by @${{ github.actor }}

on:
  push:
    branches: ["develop"] #TODO change to main/master for release

jobs:
  build_infrastructure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 20
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '20' # for mvn clean package

      - name: Pull docker images
        run: |
          docker pull hashicorp/terraform:latest
          docker pull localstack/localstack:latest

      - name: Start LocalStack
        run: |
          cd infra/localstack
          docker-compose up -d
      - name: Install tokenizer libraries
        run: |
          pip install -r ./tokenizer/requirements.txt --target ./tokenizer
      - name: Zip tokenizer
      - run: |
          cd tokenizer
          zip -r ../tokenizer.zip *
      - name: Zip model trainer
      - run: |
          cd model_trainer
          zip -r ../model_trainer.zip *
      - name: Zip name suggester
      - run: |
          cd name_suggester
          zip -r ../name_suggester.zip *
      - name: Zip event writer
      - run: |
          cd infra/utils/event_writer
          zip -r ../event_writer.zip *
      - name: Zip event personalizer
      - run: |
          cd infra/utils/event_personalizer
          zip -r ../event_personalizer.zip *
      - name: Package parser
      - run: |
          cd parser
          mvn clean package
      - name: Package code metrics
      - run: |
          cd code_metrics
          mvn clean package
      - name: Package metrics provider
      - run: |
          cd metrics_provider
          mvn clean package
      - name: Deploy with Terraform
        run: |
          cd infra/terraform
          docker-compose run --rm terraform init
          docker-compose run --rm terraform apply --auto-approve

    
